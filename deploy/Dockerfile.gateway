# OpenClawd Gateway - Security-Hardened Container
# For autonomous agent deployment with isolation
#
# Build: docker build -f deploy/Dockerfile.gateway -t openclawd-gateway .
# Run:   docker compose -f deploy/docker-compose.gateway.yml up -d

FROM node:22-bookworm-slim

# Install runtime dependencies
# - chromium: for WhatsApp/Signal browser sessions
# - git: for agent exec tool
# - common tools: curl, jq, ripgrep for agent tasks
# - unzip: required for Bun install
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    chromium \
    curl \
    git \
    jq \
    procps \
    ripgrep \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Set Puppeteer to use system Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# Install Bun for build
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:${PATH}"

RUN corepack enable

WORKDIR /app

# Copy package files first for layer caching
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY ui/package.json ./ui/package.json
COPY patches ./patches
COPY scripts ./scripts

RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN OPENCLAW_A2UI_SKIP_MISSING=1 pnpm build
ENV OPENCLAW_PREFER_PNPM=1
RUN pnpm ui:build

# Create user with same UID/home as typical host setup
# This allows mounting host config with correct permissions
ARG HOST_USER=azureuser
ARG HOST_UID=1000
ARG HOST_GID=1000

# The node image has UID 1000 as 'node' user. We'll:
# 1. Rename node user/group to match host user name
# 2. Create home directory at /home/$HOST_USER
# 3. Symlink so paths work regardless of container user name
RUN usermod -l ${HOST_USER} node 2>/dev/null || true && \
    groupmod -n ${HOST_USER} node 2>/dev/null || true && \
    mkdir -p /home/${HOST_USER} && \
    usermod -d /home/${HOST_USER} ${HOST_USER} 2>/dev/null || true && \
    chown -R ${HOST_UID}:${HOST_GID} /home/${HOST_USER} /app

# Create data directories matching host paths
RUN mkdir -p /home/${HOST_USER}/.openclaw && \
    chown -R ${HOST_UID}:${HOST_GID} /home/${HOST_USER}

ENV NODE_ENV=production
ENV HOME=/home/${HOST_USER}

# Security: Run as non-root (use the renamed user)
USER ${HOST_USER}

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -sf http://localhost:18789/health || exit 1

EXPOSE 18789

# Default: loopback binding (override with --bind lan for container networking)
CMD ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789"]
