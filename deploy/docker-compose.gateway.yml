# OpenClawd Gateway - Docker Compose Deployment
#
# Usage:
#   1. Copy .env.example to .env and fill in your secrets
#   2. docker compose -f deploy/docker-compose.gateway.yml up -d
#
# First time setup:
#   docker compose -f deploy/docker-compose.gateway.yml build

services:
  openclawd-gateway:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.gateway
      args:
        # Match your host user for permission compatibility
        HOST_USER: ${HOST_USER:-azureuser}
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    image: openclawd-gateway:latest
    container_name: openclawd-gateway
    restart: unless-stopped
    init: true

    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 512M

    # Security: Drop capabilities and set read-only where possible
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      # Needed for chromium sandbox
      - SYS_ADMIN
    security_opt:
      - no-new-privileges:true

    environment:
      # Core - HOME must match host paths in config
      HOME: /home/${HOST_USER:-azureuser}
      NODE_ENV: production
      TZ: ${TZ:-UTC}

      # Gateway auth (required for security)
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:?Gateway token required}

      # Provider API keys
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      AZURE_OPENAI_ENDPOINT: ${AZURE_OPENAI_ENDPOINT:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # Discord bot
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}

      # Chromium for WhatsApp/Signal
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
      PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium

    volumes:
      # Main config directory - mount at same path as host for config compatibility
      # This includes: workspace, workspace-*, goal-loop, planner, agents, browser, etc.
      - ${OPENCLAW_CONFIG_DIR:-~/.openclaw}:/home/${HOST_USER:-azureuser}/.openclaw

      # Secrets file (read-only)
      - ${SECRETS_FILE:-./secrets.env}:/run/secrets/openclaw.env:ro

      # Agent workspaces (these paths are hardcoded in openclaw.json)
      # The main .openclaw mount above covers these, but you can override:
      # - ${WORKSPACE_DIR:-~/.openclaw/workspace}:/home/${HOST_USER:-azureuser}/.openclaw/workspace

      # For extra isolation, you can use named volumes instead:
      # - openclawd-config:/home/${HOST_USER:-azureuser}/.openclaw

    ports:
      # Bind to localhost only for security (matches systemd loopback binding)
      - "127.0.0.1:${GATEWAY_PORT:-18789}:18789"

    # Security: Restrict network (optional - uncomment for stricter isolation)
    # networks:
    #   - openclawd-internal

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Named volumes (only used if you uncomment the named volume mount above)
# volumes:
#   openclawd-config:
#     name: openclawd-config

# Optional: Isolated network
# networks:
#   openclawd-internal:
#     driver: bridge
